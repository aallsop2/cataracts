---
title: "Three (Groups of) Blind Mice" 
subtitle: "Familial Clusters of Cataract Development in Irradiated Mice"
author: "Alyssa Allsop and Amira Burns"
date: "`r Sys.Date()`"
output: 
  ioslides_presentation: 
    widescreen: true
    fontsize: 10
---

```{r setup, include=FALSE, warning = FALSE}
knitr::opts_chunk$set(echo = FALSE)
```  

```{r, include=FALSE}

library(readxl)
library(tidyverse)
library(lme4)
library(broom.mixed)
library(kableExtra)
library(ggsci)
library(coda)
library(rjags)
library(R2jags)
library(superdiag)
library(mcmcplots)
library(ggmcmc)
library(emmeans)
```

  

## Introduction
  
- Research Questions:   
    + Are mice in some families more likely to develop more severe cataracts?
- Experimental Design:  
    + 1820 genetically heterogeneous mice from 48 unique families were randomly assigned, with equal family weights, to three treatment groups: Gamma radiation, HZE radiation, and unirradiated control. The simplified dataset records symptoms at time of death for mice of Age $\ge$ 552 days, for a total sample size of 1169.   
    + **Response**: Cataracts Status, either 0 or 1. Where 1 indicates the presence of cataracts that are of clinical concern.  
    + **Primary predictors under consideration**: Treatment, Family  
    + **Covariates**: Sex, Weight, Coat Color, Body Condition Score, Age, Myeloid Leukemia, Harderian Tumor, PreT Lymphoma


## Summary Tables & Plots {.smaller}
```{r load_data}
cats <- read_excel("GRSD.cataract.xlsx", sheet = "Sheet1")
```

```{r format_data, include = FALSE}
# remove spaces from column and value names
names(cats) <- str_replace_all(names(cats), " ", "_")
cats <- cats %>%
  mutate(CoatColor = str_replace_all(coat_color, " ", "_"))
str(cats)

# turn categorical vars into factor
cats <- cats %>%
  rename(Age = `age_(days)`,
         Weight = weight,
         Animal = animal) %>%
  mutate(Sex = as.factor(sex),
         CoatColor = as.factor(CoatColor),
         Family = as.factor(family), # should this stay a factor? Yes?
         BCS = as.ordered(BCS),
         Treatment = relevel(as.factor(groups), ref = "Unirradiated"),
         MyeloidLeukemia = as.factor(Myeloid_Leukemia),
         HarderianTumor = as.factor(Harderian_Tumor),
         PreTLymphoma = as.factor(PreT_Lymphoma),
         Score = as.ordered(Cataract_Score)) # ordinal cat; leave as numeric?

# select vars, add binary conversion for score
cats <- cats %>%
  select(c(Animal, Sex, Weight, CoatColor, Family, BCS, Age, Treatment,
           MyeloidLeukemia, HarderianTumor, PreTLymphoma, Score)) %>%
  mutate(Cataracts = ifelse(Score < 2, 0, 1))

# glance at the dataset
# str(cats)

sex_trt <- cats %>%
  group_by(Treatment, Sex, Cataracts) %>%
  summarise(n = n()) %>%
  ungroup() %>%
  group_by(Treatment, Sex) %>%
  mutate(prop = round(n/sum(n), digits = 2))

sum_tab <- sex_trt %>%
  pivot_wider(names_from = Sex, values_from = c(n, prop)) %>%
  mutate(Cataracts = ifelse(Cataracts == 0, "No", "Yes"),
         Treatment = rep(" ", 1)) %>%
  relocate(prop_F, .after = n_F)
n_C <- c(438, 58, 214, 63, 281, 115)
prop_C <- c(0.88, 0.12, 0.77, 0.23, 0.71, 0.29)

sum_tab <- sum_tab %>%
  ungroup() %>%
  mutate(n_C = n_C, prop_C = prop_C) %>%
  add_row(Treatment = " ", Cataracts = "$\\sum$", n_F = 258, prop_F = NA,
          n_M = 238, prop_M = NA, n_C = 496, prop_C = NA, .after = 2) %>%
  add_row(Treatment = " ", Cataracts = "$\\sum$", n_F = 145, prop_F = NA,
          n_M = 132, prop_M = NA, n_C = 277, prop_C = NA, .after = 5) %>%
  add_row(Treatment = " ", Cataracts = "$\\sum$", n_F = 205, prop_F = NA,
          n_M = 191, prop_M = NA, n_C = 396, prop_C = NA, .after = 8) %>%
  add_row(Treatment = " ", Cataracts = "$\\sum$", n_F = 608, prop_F = NA,
          n_M = 561, prop_M = NA, n_C = 1169, prop_C = NA, .after = 9)

grsex_score <- cats %>%
  group_by(Sex, Treatment, Family) %>%
  summarize(mean_score = mean(Cataracts))
```

```{r}
ggplot(grsex_score, aes(x = Treatment, y = mean_score, color = Sex)) +
  geom_line(aes(group = Family)) + facet_wrap(vars(Sex)) +
  scale_color_startrek() +
  scale_x_discrete(expand = c(0, .2)) +
  theme_light() +
  labs(y = "mean score",
       title = "Cataracts by Family, Sex, Treatment Group")

```


## Mixed Logistic Regression
```{r glmm, include = FALSE}
# mixed model binomial logistic regression using adaptive Gauss-Hermite quadrature (nAGQ = 25)
mix_mod_full <- glmer(Cataracts ~ Sex + Weight + CoatColor + BCS + HarderianTumor + 
                        MyeloidLeukemia + PreTLymphoma + Treatment + (1|Family), nAGQ = 25, 
                      data = cats, family = binomial)
mixed_mod <- glmer(Cataracts ~ Sex*Treatment + (1|Family), nAGQ = 25, data = cats, family = binomial)
fixed_mod_full <- glm(Cataracts ~ Sex + Weight + CoatColor + BCS + HarderianTumor + 
                        MyeloidLeukemia + PreTLymphoma + Treatment, data = cats, family = binomial)
fixed_mod <- glm(Cataracts ~ Treatment*Sex, data = cats, family = binomial)


# test full vs reduced mixed models
anova(mix_mod_full, mixed_mod)

summary(mix_mod_full)
summary(mixed_mod)
summary(fixed_mod)
```

```{r}
#table of AIC values


aics <- c(AIC(mix_mod_full), AIC(mixed_mod), AIC(fixed_mod))
bics <- c(BIC(mix_mod_full), BIC(mixed_mod), BIC(fixed_mod))
dt <- rbind(aics, bics)
colnames(dt) <- c("Full Mixed Model", "Reduced Mixed Model", "Fixed Effects Model")
rownames(dt) <- c("AIC", "BIC")

dt %>% 
  kbl(caption = "AIC and BIC Comparisons Across Models", digits = 2) %>% 
  kable_classic_2(full_width = T, html_font = "Cambria")

```
* Model Selection
  + Full model including all predictors and covariates plus a random intercept for family
  + Reduced model only including: sex, treatment group, and a random intercept for family
  + Fixed effects model including only sex and treatment group
* Final model includes:
  + Sex, Treatment, and Random Intercept for Family
  
## Mixed Logistic Regression
* The final model can be written as:  
\[
\begin{aligned}
Y \sim\ &Binomial(1169, p)\ \ \mbox{or parameterized as   }\  Y_{ij} \sim Bernoulli(p) \\
log(\frac{p}{1-p}) = &\ \beta_0*Unirradiated_i*F_i\ +\beta_1*Gamma_i*F_i\ + \beta_2*HZE_i*F_i\ + \\ &\beta_3*Unirradiated_i*M_i\ +\beta_4*Gamma_i*M_i\ + \beta_5*HZE_i*M_i\ + \\
[&v_{j} + \epsilon_{ij}] \\
&i = 1, ..., 1169\ \mbox{ mice} \\
&j = 1,...,47\ \ \mbox{ families}
\end{aligned}
\]  



## Bayesian Mixed Logistic Regression
<div class='"columns-2">

The final Bayesian model can be written as:  
\[
\begin{aligned}
Y \sim Binomial&(1169, p) \ \mbox{   or parameterized as   }\ \ \  Y_{ij} \sim Bernoulli(p)\\
log(\frac{p}{1-p}) = &\ \beta_0*Control_i*F_i\ +\beta_1*Gamma_i*F_i\ + \beta_2*HZE_i*F_i\ + \\ &\beta_3*Control_i*M_i\ +\beta_4*Gamma*M\ + \beta_5*HZE*M\ + \\
&v_{ij} + \epsilon_{ij}\\
&i = 1, ..., 1169\ \mbox{ mice} \\
&j = 1,...,47\ \ \mbox{ families, and} \\
v_j \sim N(0, \tau)
\end{aligned}
\]  


With non-informative parameters:  
\[
\begin{aligned}
\beta_0 &\sim N(0, 0.001)\\
\beta_1 &\sim N(0, 0.001)\\
\beta_2 &\sim N(0, 0.001)\\
\beta_3 &\sim N(0, 0.001)\\
\beta_4 &\sim N(0, 0.001)\\
\beta_5 &\sim N(0, 0.001)\\
\tau &\sim Gamma(0.001, 0.001) \mbox{ where}\ \sigma^2 = 1/\tau\\
\end{aligned}
\]
 
</div>  

```{r postdens}
p0 <- ggplot(posts, aes(x = b0)) +
  geom_density(color = "cyan4", fill = "aquamarine4", alpha = 0.5) +
  geom_vline(aes(xintercept = bayes_tab[1,5]), color = "darkorchid", linetype = "dashed") +
  geom_vline(aes(xintercept = bayes_tab[1,6]), color = "darkorchid", linetype = "dashed") +
  geom_vline(aes(xintercept = bayes_tab[1,2]), color = "darkorange3") +
  scale_x_continuous(expand = c(0, 0)) +
  theme_light() +
  theme(plot.title = element_text(size= 12)) + 
  labs(x = "Probability",
       title = "Female Control")

p1 <- ggplot(posts, aes(x = b1)) +
  geom_density(color = "cyan4", fill = "aquamarine4", alpha = 0.5) +
  geom_vline(aes(xintercept = bayes_tab[2,5]), color = "darkorchid", linetype = "dashed") +
  geom_vline(aes(xintercept = bayes_tab[2,6]), color = "darkorchid", linetype = "dashed") +
  geom_vline(aes(xintercept = bayes_tab[2,2]), color = "darkorange3") +
  scale_x_continuous(expand = c(0, 0)) +
  theme_light() +
  theme(plot.title = element_text(size= 12)) + 
  labs(x = "Probability",
       title = "Female Gamma")

p2 <- ggplot(posts, aes(x = b2)) +
  geom_density(color = "cyan4", fill = "aquamarine4", alpha = 0.5) +
  geom_vline(aes(xintercept = bayes_tab[3,5]), color = "darkorchid", linetype = "dashed") +
  geom_vline(aes(xintercept = bayes_tab[3,6]), color = "darkorchid", linetype = "dashed") +
  geom_vline(aes(xintercept = bayes_tab[3,2]), color = "darkorange3") +
  scale_x_continuous(expand = c(0, 0)) +
  theme_light() +
  theme(plot.title = element_text(size= 12)) + 
  labs(x = "Probability",
       title = "Female HZE")

p3 <- ggplot(posts, aes(x = b3)) +
  geom_density(color = "cyan4", fill = "aquamarine4", alpha = 0.5) +
  geom_vline(aes(xintercept = bayes_tab[4,5]), color = "darkorchid", linetype = "dashed") +
  geom_vline(aes(xintercept = bayes_tab[4,6]), color = "darkorchid", linetype = "dashed") +
  geom_vline(aes(xintercept = bayes_tab[4,2]), color = "darkorange3") +
  scale_x_continuous(expand = c(0, 0)) +
  theme_light() +
  theme(plot.title = element_text(size= 12)) + 
  labs(x = "Probability",
       title = "Male Contro")

p4 <- ggplot(posts, aes(x = b4)) +
  geom_density(color = "cyan4", fill = "aquamarine4", alpha = 0.5) +
  geom_vline(aes(xintercept = bayes_tab[5,5]), color = "darkorchid", linetype = "dashed") +
  geom_vline(aes(xintercept = bayes_tab[5,6]), color = "darkorchid", linetype = "dashed") +
  geom_vline(aes(xintercept = bayes_tab[5,2]), color = "darkorange3") +
  scale_x_continuous(expand = c(0, 0)) +
  theme_light() +
  theme(plot.title = element_text(size= 12)) + 
  labs(x = "Probability",
       title = "Male Gamma")

p5 <- ggplot(posts, aes(x = b5)) +
  geom_density(color = "cyan4", fill = "aquamarine4", alpha = 0.5) +
  geom_vline(aes(xintercept = bayes_tab[6,5]), color = "darkorchid", linetype = "dashed") +
  geom_vline(aes(xintercept = bayes_tab[6,6]), color = "darkorchid", linetype = "dashed") +
  geom_vline(aes(xintercept = bayes_tab[6,2]), color = "darkorange3") +
  scale_x_continuous(expand = c(0, 0)) +
  theme_light() +
  theme(plot.title = element_text(size= 12)) + 
  labs(x = "Probability",
       title = "Male HZE")


p6 <- ggplot(posts, aes(x = sigma2)) +
  geom_density(color = "cyan4", fill = "aquamarine4", alpha = 0.5) +
  geom_vline(aes(xintercept = bayes_tab[7,5]), color = "darkorchid", linetype = "dashed") +
  geom_vline(aes(xintercept = bayes_tab[7,6]), color = "darkorchid", linetype = "dashed") +
  geom_vline(aes(xintercept = bayes_tab[7,3]), color = "darkorange3") + # calculate mode and replot
  scale_x_continuous(expand = c(0, 0)) +
  theme_light() +
  theme(plot.title = element_text(size= 12)) + 
  labs(x = "Probability",
       title = "Random Family Variance")

grid.arrange(p0, p1, p2, p3, p4, p5, p6, 
             ncol = 3, top = "Posterior Densities with 95% HPD Intervals")
```
  
## Results & Conclusions {.smaller}  

- Our frequentist model shows the difference in cataract development among treatment groups is much larger among male rats
- Overall, the HZE group had the highest development of cataracts, followed by the Gamma group and then the unirradiated rats.

```{r, include = FALSE}
cats_emms <- emmeans(mixed_mod, ~ Treatment | Sex, infer = TRUE, type = "response")
pairs(cats_emms, reverse = TRUE)
```

```{r}
emmip(cats_emms, Treatment ~ Sex) + theme_light() + ggtitle("Predicted Probabilities of Cataracts \nby Sex and Treatment Group") + scale_color_startrek() + ylab("Predicted Probabilities")
```
- Limitations?  
- What questions does this raise for future studies?  
  
## References  
  
# Any Questions?  
