---
title: "Three (Groups of) Blind Mice" 
subtitle: "Familial Clusters of Cataract Development in Irradiated Mice"
author: "Alyssa Allsop and Amira Burns"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE) # change to echo = FALSE for final
```

```{r load_libs}
library(readxl)
library(tidyverse)
library(lme4)
library(broom.mixed)
library(kableExtra)
library(ggsci)
library(coda)
library(rjags)
library(R2jags)
library(superdiag)
library(mcmcplots)
library(ggmcmc)
```

```{r load_data}
cats <- read_excel("GRSD.cataract.xlsx", sheet = "Sheet1")
```

```{r format_data}
# remove spaces from column and value names
names(cats) <- str_replace_all(names(cats), " ", "_")
cats <- cats %>%
  mutate(CoatColor = str_replace_all(coat_color, " ", "_"))
str(cats)

# turn categorical vars into factor
cats <- cats %>%
  rename(Age = `age_(days)`,
         Weight = weight,
         Animal = animal) %>%
  mutate(Sex = as.factor(sex),
         CoatColor = as.factor(CoatColor),
         Family = as.factor(family), # should this stay a factor? Yes?
         BCS = as.ordered(BCS),
         Treatment = relevel(as.factor(groups), ref = "Unirradiated"),
         MyeloidLeukemia = as.factor(Myeloid_Leukemia),
         HarderianTumor = as.factor(Harderian_Tumor),
         PreTLymphoma = as.factor(PreT_Lymphoma),
         Score = as.ordered(Cataract_Score)) # ordinal cat; leave as numeric?

# select vars, add binary conversion for score
cats <- cats %>%
  select(c(Animal, Sex, Weight, CoatColor, Family, BCS, Age, Treatment,
           MyeloidLeukemia, HarderianTumor, PreTLymphoma, Score)) %>%
  mutate(Cataracts = ifelse(Score < 2, 0, 1))

# glance at the dataset
# str(cats)
```

## Abstract

## Introduction

## Summary Statistics  

```{r table}
sex_trt <- cats %>%
  group_by(Treatment, Sex, Cataracts) %>%
  summarise(n = n()) %>%
  ungroup() %>%
  group_by(Treatment, Sex) %>%
  mutate(prop = round(n/sum(n), digits = 2))

sum_tab <- sex_trt %>%
  pivot_wider(names_from = Sex, values_from = c(n, prop)) %>%
  mutate(Cataracts = ifelse(Cataracts == 0, "No", "Yes"),
         Treatment = rep(" ", 1)) %>%
  relocate(prop_F, .after = n_F)
n_C <- c(438, 58, 214, 63, 281, 115)
prop_C <- c(0.88, 0.12, 0.77, 0.23, 0.71, 0.29)

sum_tab <- sum_tab %>%
  ungroup() %>%
  mutate(n_C = n_C, prop_C = prop_C) %>%
  add_row(Treatment = " ", Cataracts = "$\\sum$", n_F = 258, prop_F = NA,
          n_M = 238, prop_M = NA, n_C = 496, prop_C = NA, .after = 2) %>%
  add_row(Treatment = " ", Cataracts = "$\\sum$", n_F = 145, prop_F = NA,
          n_M = 132, prop_M = NA, n_C = 277, prop_C = NA, .after = 5) %>%
  add_row(Treatment = " ", Cataracts = "$\\sum$", n_F = 205, prop_F = NA,
          n_M = 191, prop_M = NA, n_C = 396, prop_C = NA, .after = 8) %>%
  add_row(Treatment = " ", Cataracts = "$\\sum$", n_F = 608, prop_F = NA,
          n_M = 561, prop_M = NA, n_C = 1169, prop_C = NA, .after = 9)

options(knitr.kable.NA = '')
kbl(sum_tab,
    caption = "Mice Counts and Percentages by Sex, Treatment Group, Cataracts",
    col.names = c("Treatment", "Cataracts", "n", "prop", "n", "prop", "n", "prop")) %>%
  kable_styling(latex_options = "hold_position") %>%
  kable_classic_2(full_width = F, html_font = "Cambria") %>%
  add_header_above(c(" " = 2, "Female" = 2, "Male" = 2, "$\\sum$" = 2)) %>%
  pack_rows(index = c("Control" = 3, "Gamma" = 3, "HZE" = 3, "$\\sum$" = 1))

```

```{r lineplot}
# Plot of average score of sex-group-family
grsex_score <- cats %>%
  group_by(Sex, Treatment, Family) %>%
  summarize(mean_score = mean(Cataracts))

# choose facet direction and just show one
ggplot(grsex_score, aes(x = Treatment, y = mean_score, color = Sex)) +
  geom_line(aes(group = Family)) + facet_grid(vars(Sex)) +
  scale_color_startrek() +
  scale_x_discrete(expand = c(0, .2)) +
  theme_light() +
  labs(y = "mean score",
       title = "Cataracts by Family, Sex, Treatment Group")

ggplot(grsex_score, aes(x = Treatment, y = mean_score, color = Sex)) +
  geom_line(aes(group = Family)) + facet_wrap(vars(Sex)) +
  scale_color_startrek() +
  scale_x_discrete(expand = c(0, .2)) +
  theme_light() +
  labs(y = "mean score",
       title = "Cataracts by Family, Sex, Treatment Group")
```

```{r barplot}
# barplot of proportion of each group with cataracts
sex_trt <- cats %>%
  group_by(Treatment, Sex, Cataracts) %>%
  summarise(n = n()) %>%
  ungroup() %>%
  group_by(Treatment, Sex) %>%
  mutate(prop = round(n/sum(n), digits = 2))

cats_grp <- sex_trt %>%
  filter(Cataracts == 1)

ggplot(cats_grp, aes(x = Sex, y = prop, fill = Treatment)) +
  geom_col(position = "dodge") +
  scale_fill_startrek() +
  theme_minimal() +
  ggtitle("Sample Proportion with Cataracts by Sex and Treatment Group")

```


## Statistical Methods

### Frequentist Approach
```{r glmm}
# mixed model binomial logistic regression using adaptive Gauss-Hermite quadrature (nAGQ = 25)

mod <- glmer(Cataracts ~ 0 + Treatment*Sex + (1|Family), data = cats, family = binomial)

summary(mod)
```

```{r glmm_ors}
plot_model(mod, sort.est = TRUE, show.values = TRUE, type = "int",
           color = "Dark2", vline.color = "darkorchid3",
           width = 0.1, title = "Final Model: Cataracts Odds Ratios by Sex, Treatment Group")
tab_model(mod, show.re.var = TRUE,
          pred.labels = c("Control(Female)", "Gamma(Female)", "HZE(Female)",
                          "Control(Male)", "Gamma(Male)", "HZE(Male)"),
          dv.labels = "Final Model Effects of Treatment on Cataracts")
```
### Bayesian Approach  
```{r spec_mod}
# Specify the model
cat("model{
  for(i in 1:N){
    CAT[i] ~ dbern(p[i])     # Bernoulli-distributed response
    logit(p[i])<- b0*Unirradiated[i] + b1*Gamma[i] + b2*HZE[i] + b3*Male[i] +
    b4*Male[i]*Gamma[i] + b5*Male[i]*HZE[i] + a[Family[i]]   # likelihood function
  }
  for(j in 1:nFam){
    a[j] ~ dnorm(0, tau)
  }
  b0 ~ dnorm(0.0, 1.0E-4)   # vaguely informative priors
  b1 ~ dnorm(0.0, 1.0E-4)
  b2 ~ dnorm(0.0, 1.0E-4)
  b3 ~ dnorm(0.0, 1.0E-4)
  b4 ~ dnorm(0.0, 1.0E-4)
  b5 ~ dnorm(0.0, 1.0E-4)
  tau ~ dgamma(1.0E-3,1.0E-3)
  sigma2 <- 1/tau     # convert precision 'tau' to variance 'sigma2'
}", file = "cat.jag")
```

```{r prep_dat}
# Prepare the data for JAGS
# break Treatment into dummy variables for each group
treatment <- model.matrix(~ Treatment - 1, cats)
sex <- model.matrix(~Sex -1, cats)
colnames(treatment) <- c("Unirradiated", "Gamma", "HZE")
cats <- data.frame(cats, treatment, sex)

# format relevant data as a list
data <- list(CAT = cats$Cataracts, Unirradiated = cats$Unirradiated, Gamma = cats$Gamma, 
             HZE = cats$HZE, Male = cats$SexM, Family = cats$Family, 
             nFam = length(unique(cats$Family)), N = nrow(cats))
```

```{r setup_alg}
nIter <- 60000
nChains <- 3
nThin <- 1
BurnIn <- 10000
nAdapt <- 1000
ests <- summary(mod)$coef[,1] # pull starting values from frequentist model
var <- as.numeric(as.data.frame(VarCorr(mod))$vcov)
inits <- list(list("tau" = var+0.2, "b0" = ests[1]+0.5, "b1" = ests[2]+0.5, "b2" = ests[3]+0.5,
                   "b3" = ests[4]+0.2, "b4" = ests[5]+0.2, "b5" = ests[6]+0.2),
              list("tau" = var-0.2, "b0" = ests[1]-0.5, "b1" = ests[2]-0.5, "b2" = ests[3]-0.5,
                   "b3" = ests[4]-0.2, "b4" = ests[5]-0.2, "b5" = ests[6]-0.2),
              list("tau" = var, "b0" = ests[1], "b1" = ests[2], "b2" = ests[3],
                   "b3" = ests[4], "b4" = ests[5], "b5" = ests[6]))
```

```{r run_bayes}
# -- Compile and run the model
params <- c("b0", "b1", "b2", "b3", "b4", "b5", "sigma2")
set.seed(556)
model.fit <- jags(data = data,
                  inits = inits,
                  parameters.to.save = params,
                  model.file = "cat.jag",
                  n.chains = nChains,
                  n.iter = nIter,
                  n.burnin = BurnIn,
                  n.thin = nThin)

```

```{r bayes_summary}
mcmc.model <- as.mcmc(model.fit)
summary(mcmc.model)

# extract mean estimates
est_means <- summary(mcmc.model)$statistics[,1]

# calculate highest posterior density (HPD) credible intervals
hpds <- hpds <- HPDinterval(mcmc.model[[3]])
```

## Limitations and Alternatives

Presence of competing risks in the experimental design obscure the presence of family clusters of cataracts. It is reasonable to assume that individuals in the irradiated Treatment groups were more likely to die due to more acute effects of irradiation before developing cataracts, compared to individuals in the control group. Simplifying the dataset by instituting a cutoff age attempts to address this limitation, but the issue persists even after excluding individuals deceased before Age = 552.  


Ordinal regression (small sample sizes)
We only have a snapshot of the data instead of the development over time

## Results and Conclusions

## Authors' Statements  
  
Both authors contributed to statistical analysis and writing for this report. Both authors read and approved the final report. Both authors contributed equally to introduction, exploratory data analysis and summary statistics. Alyssa Allsop served as the primary statistician on Frequentist models; Amira Burns served as the primary statistician on Bayesian models. 

## References  

Agresti, A (2013). *Categorical Data Analysis* (Third Edition). John Wiley & Sons.  
  
Chernyavskiy, P., Edmondson, E. F., Weil, M. M., & Little, M. P. (2017). *High-energy particle beam and gamma radiation exposure, familial relatedness and cancer in mice.* British journal of cancer, 117(1), 41â€“50. https://doi.org/10.1038/bjc.2017.141  
  
Gelman, A., Carlin, J., Stern, H., Dunson, D., Vehtari, A., Rubin, D. (2014). *Bayesian Data Analysis* (Third Edition). CRC Press.  
  
Roback, P., Legler, J. (2021). *Beyond Multiple Linear Regression. Applied Generalized Linear Models and Multilevel Models in R* (Second Edition). CRC Press. Online version: https://bookdown.org/roback/bookdown-BeyondMLR/  
  
DiMaggio, C., Albert, J., Spiegelhalter, D., Best, N., Gelman, A., Carstensen, B., Guerrin, L., Jensen, S. (2015) *Bayesian Analysis for Epidemiologists III: Regression Modeling.* Center for Injury Epidemiology and Prevention at Columbia University.  http://www.columbia.edu/~cjd11/charles_dimaggio/DIRE/styled-4/styled-11/code-8/#bayesian-regression-modeling-with-bugs-or-jags

## Appendix
